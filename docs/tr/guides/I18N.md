# gRPC i18n Pattern

Bu rehber, gRPC hata mesajları için metadata pattern kullanarak uluslararasılaştırma (i18n) implementasyonunu açıklar.

## Genel Bakış

Dil bilgisi, her proto mesajına `lang` alanı eklemek yerine gRPC Metadata (`accept-language` header) üzerinden gönderilir. Bu, proto tanımlarını temiz tutar ve HTTP header convention'larını takip eder.

## Mimari

```
Gateway                              Auth Service
   │                                      │
   │  gRPC Call                           │
   │  + Metadata: accept-language=tr      │
   │ ────────────────────────────────────>│
   │                                      │
   │                      ┌───────────────┴───────────────┐
   │                      │ Context Interceptor           │
   │                      │ - Metadata'dan locale çıkar   │
   │                      │ - RequestContext'i ayarla     │
   │                      └───────────────┬───────────────┘
   │                                      │
   │                      ┌───────────────┴───────────────┐
   │                      │ Handler                       │
   │                      │ - İş mantığını işle           │
   │                      │ - createGrpcErrorResponse çağır│
   │                      └───────────────┬───────────────┘
   │                                      │
   │                      ┌───────────────┴───────────────┐
   │                      │ Error Handler                 │
   │                      │ - Context'ten locale al       │
   │                      │ - Hata mesajını çevir         │
   │                      └───────────────┬───────────────┘
   │                                      │
   │  Response (çevrilmiş hata)           │
   │ <────────────────────────────────────│
```

## Temel Bileşenler

### 1. RequestContext (Auth Service)

Konum: `src/shared/context/RequestContext.ts`

Request-scoped veri saklamak için Node.js AsyncLocalStorage kullanır:

```typescript
import { AsyncLocalStorage } from 'async_hooks';

interface RequestContextData {
  locale: string;
  requestId?: string;
}

class RequestContextClass {
  private storage = new AsyncLocalStorage<RequestContextData>();

  run<T>(data: RequestContextData, fn: () => T): T {
    return this.storage.run(data, fn);
  }

  getLocale(): string {
    return this.storage.getStore()?.locale || 'en';
  }
}

export const RequestContext = new RequestContextClass();
```

### 2. Context Interceptor (Auth Service)

Konum: `src/grpc/interceptors/contextInterceptor.ts`

Handler'ları wrap ederek locale çıkarır ve context ayarlar:

```typescript
export function wrapHandlersWithContext(handlers: HandlerMap): HandlerMap {
  const wrapped: HandlerMap = {};

  for (const [name, handler] of Object.entries(handlers)) {
    wrapped[name] = (call, callback) => {
      const locale = extractLocaleFromMetadata(call.metadata);

      RequestContext.run({ locale }, () => {
        handler(call, callback);
      });
    };
  }

  return wrapped;
}

function extractLocaleFromMetadata(metadata: grpc.Metadata): string {
  const acceptLanguage = metadata.get('accept-language');
  return acceptLanguage?.[0]?.toString() || 'en';
}
```

### 3. Error Handler (Auth Service)

Konum: `src/shared/errors/grpcErrorHandler.ts`

Otomatik olarak context'ten locale kullanır:

```typescript
export function createGrpcErrorResponse(error: unknown, fallbackType: string) {
  const locale = RequestContext.getLocale(); // Parametre gerekmiyor!
  const message = translateError(error, locale);
  return { success: false, error: message };
}
```

### 4. Gateway Client

Konum: `lobsterlead-gateway/src/infra/clients/BaseGrpcClient.ts`

Locale'i metadata üzerinden gönderir:

```typescript
private executeCall<TRequest, TResponse>(
  methodName: string,
  request: TRequest,
  locale?: string
): Promise<TResponse> {
  const metadata = new grpc.Metadata();
  if (locale) {
    metadata.set('accept-language', locale);
  }

  method.call(this.client, request, metadata, { deadline }, callback);
}
```

## Kullanım

### Handler (lang parametresi gerekmiyor)

```typescript
async function signIn(call, callback): Promise<void> {
  const { email, password } = call.request; // 'lang' alanı yok

  try {
    const result = await loginUseCase.execute({ email, password });
    callback(null, { success: true, user: result.user });
  } catch (error) {
    // Locale otomatik olarak context'ten çıkarılır
    callback(null, createGrpcErrorResponse(error, 'LOGIN_FAILED'));
  }
}
```

### Gateway Çağrısı

```typescript
async signIn(data: { email: string; password: string; lang?: string }) {
  const grpcRequest = { email: data.email, password: data.password };

  return this.callWithFallback({
    methodName: 'SignIn',
    grpcMethod: (req, locale) => this.grpcClient.signIn(req, locale),
    request: grpcRequest,
    locale: data.lang,  // Request body yerine metadata ile gönderilir
  });
}
```

## Desteklenen Diller

- `en` - İngilizce (varsayılan)
- `tr` - Türkçe

## Yeni Servis Ekleme

1. `RequestContext.ts`'yi yeni servise kopyala
2. `contextInterceptor.ts`'yi yeni servise kopyala
3. `createGrpcErrorResponse`'u `RequestContext.getLocale()` kullanacak şekilde güncelle
4. Handler'ları `server.ts`'de wrap et:
   ```typescript
   const wrappedHandlers = wrapHandlersWithContext(handlers);
   server.addService(AuthService, wrappedHandlers);
   ```
5. Gateway zaten locale'i metadata ile gönderiyor - değişiklik gerekmez

## Çeviri Dosya Yapısı

Çeviriler `src/shared/i18n/locales/` altındaki JSON dosyalarında saklanır:

```
src/shared/i18n/
├── index.ts         # t() fonksiyonunu içeren ana modül
├── types.ts         # Çeviri anahtarları için tip tanımları
└── locales/
    ├── tr.json      # Türkçe çeviriler
    └── en.json      # İngilizce çeviriler
```

### JSON Dosya Formatı

```json
{
  "common": {
    "internalError": "Beklenmeyen bir hata oluştu. Lütfen daha sonra tekrar deneyin.",
    "validationError": "Geçersiz istek. Lütfen girdiğiniz bilgileri kontrol edin.",
    "notFound": "İstenen kaynak bulunamadı."
  },
  "auth": {
    "loginFailed": "Geçersiz e-posta veya şifre.",
    "registrationFailed": "Kayıt başarısız oldu. Lütfen tekrar deneyin."
  }
}
```

### Çevirileri Kullanma

```typescript
import { t } from '../shared/i18n/index.js';

// RequestContext'ten locale'i otomatik alır
const message = t('common.notFound');

// Veya açık locale ile
const message = t('common.notFound', 'en');
```

### Yeni Çeviri Anahtarı Ekleme

1. Anahtarı `types.ts`'ye ekle:
```typescript
export type AuthTranslationKey =
  | 'auth.loginFailed'
  | 'auth.newKey';  // Buraya ekle

export type TranslationKey = CommonTranslationKey | AuthTranslationKey;
```

2. Her iki JSON dosyasına çevirileri ekle:
```json
// tr.json
{ "auth": { "newKey": "Türkçe mesaj" } }

// en.json
{ "auth": { "newKey": "English message" } }
```

3. Hata mesajlarından eşleştirme yapılacaksa, `ERROR_MESSAGE_TO_KEY`'e ekle:
```typescript
export const ERROR_MESSAGE_TO_KEY: Record<string, TranslationKey> = {
  'my error message': 'auth.newKey',
};
```

## En İyi Uygulamalar

1. **Proto mesajlarına asla `lang` alanı ekleme** - bunun yerine metadata kullan
2. **Hata handler'larında her zaman `RequestContext.getLocale()` kullan**
3. **Locale sağlanmadığında 'tr' varsayılan olarak kullan** (Türkçe varsayılandır)
4. **Çevirileri JSON dosyalarında tut** `src/shared/i18n/locales/` altında
5. **Tip-güvenli anahtarlar kullan** - yeni anahtarları her zaman `types.ts`'ye ekle
6. **Çevirileri domain'e göre grupla** - örn. `common.`, `auth.`, `workspace.`
